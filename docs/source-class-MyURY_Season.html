<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="generator" content="ApiGen 2.8.0" />
	<meta name="robots" content="noindex" />

	<title>File src/Classes/ServiceAPI/MyURY_Season.php | MyURY</title>

	<script type="text/javascript" src="resources/combined.js?1889508232"></script>
	<script type="text/javascript" src="elementlist.js?462916175"></script>
	<link rel="stylesheet" type="text/css" media="all" href="resources/style.css?3505392360" />

</head>

<body>
<div id="left">
	<div id="menu">
		<a href="index.html" title="Overview"><span>Overview</span></a>


		<div id="groups">
			<h3>Packages</h3>
			<ul>
				<li class="active"><a href="package-MyURY.html">MyURY<span></span></a>
						<ul>
				<li class="active"><a href="package-MyURY.Core.html">Core</a>
						</li>
				<li><a href="package-MyURY.Demo.html">Demo</a>
						</li>
				<li><a href="package-MyURY.Podcast.html">Podcast</a>
						</li>
				<li><a href="package-MyURY.Profile.html">Profile</a>
						</li>
				<li><a href="package-MyURY.Scheduler.html">Scheduler</a>
						</li>
				<li><a href="package-MyURY.Webcam.html">Webcam</a>
						</li>
							</ul></li>
				<li><a href="package-None.html">None</a>
						</li>
				<li><a href="package-PHP.html">PHP</a>
						</li>
			</ul>
		</div>

		<hr />


		<div id="elements">
			<h3>Classes</h3>
			<ul>
				<li><a href="class-APCProvider.html">APCProvider</a></li>
				<li><a href="class-Config.html">Config</a></li>
				<li><a href="class-CoreUtils.html">CoreUtils</a></li>
				<li><a href="class-Database.html">Database</a></li>
				<li><a href="class-MyURY_Scheduler_Common.html">MyURY_Scheduler_Common</a></li>
				<li class="active"><a href="class-MyURY_Season.html">MyURY_Season</a></li>
				<li><a href="class-MyURY_Show.html">MyURY_Show</a></li>
				<li><a href="class-MyURY_Timeslot.html">MyURY_Timeslot</a></li>
				<li><a href="class-MyURYEmail.html">MyURYEmail</a></li>
				<li><a href="class-MyURYError.html">MyURYError</a></li>
				<li><a href="class-MyURYForm.html">MyURYForm</a></li>
				<li><a href="class-MyURYFormField.html">MyURYFormField</a></li>
				<li><a href="class-MyURYMenu.html">MyURYMenu</a></li>
				<li><a href="class-MyURYNews.html">MyURYNews</a></li>
				<li><a href="class-ServiceAPI.html">ServiceAPI</a></li>
				<li><a href="class-Track.html">Track</a></li>
				<li><a href="class-URYTwig.html">URYTwig</a></li>
				<li><a href="class-User.html">User</a></li>
			</ul>

			<h3>Interfaces</h3>
			<ul>
				<li><a href="class-CacheProvider.html">CacheProvider</a></li>
				<li><a href="class-IServiceAPI.html">IServiceAPI</a></li>
				<li><a href="class-Singleton.html">Singleton</a></li>
				<li><a href="class-TemplateEngine.html">TemplateEngine</a></li>
			</ul>


			<h3>Exceptions</h3>
			<ul>
				<li><a href="class-MyURYException.html">MyURYException</a></li>
			</ul>


		</div>
	</div>
</div>

<div id="splitter"></div>

<div id="right">
<div id="rightInner">
	<form id="search">
		<input type="hidden" name="cx" value="" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text" name="q" class="text" />
		<input type="submit" value="Search" />
	</form>

	<div id="navigation">
		<ul>
			<li>
				<a href="index.html" title="Overview"><span>Overview</span></a>
			</li>
			<li>
				<a href="package-MyURY.Core.html" title="Summary of MyURY\Core"><span>Package</span></a>
			</li>
			<li>
				<a href="class-MyURY_Season.html" title="Summary of MyURY_Season"><span>Class</span></a>
			</li>
		</ul>
		<ul>
			<li>
				<a href="tree.html" title="Tree view of classes, interfaces, traits and exceptions"><span>Tree</span></a>
			</li>
		</ul>
		<ul>
		</ul>
	</div>

<pre><code><span id="1" class="l"><a class="l" href="#1">  1: </a><span class="xlang">&lt;?php</span>
</span><span id="2" class="l"><a class="l" href="#2">  2: </a>
</span><span id="3" class="l"><a class="l" href="#3">  3: </a><span class="php-comment">/*
</span></span><span id="4" class="l"><a class="l" href="#4">  4: </a><span class="php-comment"> * Provides the Season class for MyURY
</span></span><span id="5" class="l"><a class="l" href="#5">  5: </a><span class="php-comment"> * @package MyURY_Scheduler
</span></span><span id="6" class="l"><a class="l" href="#6">  6: </a><span class="php-comment"> */</span>
</span><span id="7" class="l"><a class="l" href="#7">  7: </a>
</span><span id="8" class="l"><a class="l" href="#8">  8: </a><span class="php-comment">/*
</span></span><span id="9" class="l"><a class="l" href="#9">  9: </a><span class="php-comment"> * The Season class is used to create, view and manupulate Seasons within the new MyURY Scheduler Format
</span></span><span id="10" class="l"><a class="l" href="#10"> 10: </a><span class="php-comment"> * @version 12082012
</span></span><span id="11" class="l"><a class="l" href="#11"> 11: </a><span class="php-comment"> * @author Lloyd Wallis &lt;lpw@ury.org.uk&gt;
</span></span><span id="12" class="l"><a class="l" href="#12"> 12: </a><span class="php-comment"> * @package MyURY_Scheduler
</span></span><span id="13" class="l"><a class="l" href="#13"> 13: </a><span class="php-comment"> * @uses \Database
</span></span><span id="14" class="l"><a class="l" href="#14"> 14: </a><span class="php-comment"> * @uses \MyURY_Show
</span></span><span id="15" class="l"><a class="l" href="#15"> 15: </a><span class="php-comment"> * 
</span></span><span id="16" class="l"><a class="l" href="#16"> 16: </a><span class="php-comment"> */</span>
</span><span id="17" class="l"><a class="l" href="#17"> 17: </a>
</span><span id="18" class="l"><a class="l" href="#18"> 18: </a><span class="php-keyword1">class</span> <a id="MyURY_Season" href="#MyURY_Season">MyURY_Season</a> <span class="php-keyword1">extends</span> MyURY_Scheduler_Common {
</span><span id="19" class="l"><a class="l" href="#19"> 19: </a>
</span><span id="20" class="l"><a class="l" href="#20"> 20: </a>  <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var"><a id="$seasons" href="#$seasons">$seasons</a></span> = <span class="php-keyword1">array</span>();
</span><span id="21" class="l"><a class="l" href="#21"> 21: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$season_id" href="#$season_id">$season_id</a></span>;
</span><span id="22" class="l"><a class="l" href="#22"> 22: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$show_id" href="#$show_id">$show_id</a></span>;
</span><span id="23" class="l"><a class="l" href="#23"> 23: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$term_id" href="#$term_id">$term_id</a></span>;
</span><span id="24" class="l"><a class="l" href="#24"> 24: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$submitted" href="#$submitted">$submitted</a></span>;
</span><span id="25" class="l"><a class="l" href="#25"> 25: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$owner" href="#$owner">$owner</a></span>;
</span><span id="26" class="l"><a class="l" href="#26"> 26: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$metadata" href="#$metadata">$metadata</a></span>;
</span><span id="27" class="l"><a class="l" href="#27"> 27: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$timeslots" href="#$timeslots">$timeslots</a></span>;
</span><span id="28" class="l"><a class="l" href="#28"> 28: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$requested_times" href="#$requested_times">$requested_times</a></span>;
</span><span id="29" class="l"><a class="l" href="#29"> 29: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$requested_weeks" href="#$requested_weeks">$requested_weeks</a></span>;
</span><span id="30" class="l"><a class="l" href="#30"> 30: </a>  <span class="php-keyword1">private</span> <span class="php-var"><a id="$season_num" href="#$season_num">$season_num</a></span>;
</span><span id="31" class="l"><a class="l" href="#31"> 31: </a>
</span><span id="32" class="l"><a class="l" href="#32"> 32: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a id="_getInstance" href="#_getInstance">getInstance</a>(<span class="php-var">$season_id</span> = <span class="php-keyword1">null</span>) {
</span><span id="33" class="l"><a class="l" href="#33"> 33: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_numeric</span>(<span class="php-var">$season_id</span>)) {
</span><span id="34" class="l"><a class="l" href="#34"> 34: </a>      <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'Invalid Season ID!'</span>, MyURYException::FATAL);
</span><span id="35" class="l"><a class="l" href="#35"> 35: </a>    }
</span><span id="36" class="l"><a class="l" href="#36"> 36: </a>
</span><span id="37" class="l"><a class="l" href="#37"> 37: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$seasons</span>[<span class="php-var">$season_id</span>])) {
</span><span id="38" class="l"><a class="l" href="#38"> 38: </a>      self::<span class="php-var">$seasons</span>[<span class="php-var">$season_id</span>] = <span class="php-keyword1">new</span> self(<span class="php-var">$season_id</span>);
</span><span id="39" class="l"><a class="l" href="#39"> 39: </a>    }
</span><span id="40" class="l"><a class="l" href="#40"> 40: </a>
</span><span id="41" class="l"><a class="l" href="#41"> 41: </a>    <span class="php-keyword1">return</span> self::<span class="php-var">$seasons</span>[<span class="php-var">$season_id</span>];
</span><span id="42" class="l"><a class="l" href="#42"> 42: </a>  }
</span><span id="43" class="l"><a class="l" href="#43"> 43: </a>
</span><span id="44" class="l"><a class="l" href="#44"> 44: </a>  <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> <a id="___construct" href="#___construct">__construct</a>(<span class="php-var">$season_id</span>) {
</span><span id="45" class="l"><a class="l" href="#45"> 45: </a>    <span class="php-var">$this</span>-&gt;season_id = <span class="php-var">$season_id</span>;
</span><span id="46" class="l"><a class="l" href="#46"> 46: </a>    <span class="php-comment">//Init Database</span>
</span><span id="47" class="l"><a class="l" href="#47"> 47: </a>    self::initDB();
</span><span id="48" class="l"><a class="l" href="#48"> 48: </a>
</span><span id="49" class="l"><a class="l" href="#49"> 49: </a>    <span class="php-comment">//Get the basic info about the season</span>
</span><span id="50" class="l"><a class="l" href="#50"> 50: </a>    <span class="php-var">$result</span> = self::<span class="php-var">$db</span>-&gt;fetch_one(<span class="php-quote">'SELECT show_id, termid, submitted, memberid,
</span></span><span id="51" class="l"><a class="l" href="#51"> 51: </a><span class="php-quote">      (SELECT array(SELECT metadata_key_id FROM schedule.season_metadata WHERE show_season_id=$1 AND effective_from &lt;= NOW()
</span></span><span id="52" class="l"><a class="l" href="#52"> 52: </a><span class="php-quote">        ORDER BY effective_from, season_metadata_id)) AS metadata_types,
</span></span><span id="53" class="l"><a class="l" href="#53"> 53: </a><span class="php-quote">      (SELECT array(SELECT metadata_value FROM schedule.season_metadata WHERE show_season_id=$1 AND effective_from &lt;= NOW()
</span></span><span id="54" class="l"><a class="l" href="#54"> 54: </a><span class="php-quote">        ORDER BY effective_from, season_metadata_id)) AS metadata,
</span></span><span id="55" class="l"><a class="l" href="#55"> 55: </a><span class="php-quote">      (SELECT array(SELECT requested_day FROM schedule.show_season_requested_time WHERE show_season_id=$1
</span></span><span id="56" class="l"><a class="l" href="#56"> 56: </a><span class="php-quote">        ORDER BY preference ASC)) AS requested_days,
</span></span><span id="57" class="l"><a class="l" href="#57"> 57: </a><span class="php-quote">      (SELECT array(SELECT start_time FROM schedule.show_season_requested_time WHERE show_season_id=$1
</span></span><span id="58" class="l"><a class="l" href="#58"> 58: </a><span class="php-quote">        ORDER BY preference ASC)) AS requested_start_times,
</span></span><span id="59" class="l"><a class="l" href="#59"> 59: </a><span class="php-quote">      (SELECT array(SELECT duration FROM schedule.show_season_requested_time WHERE show_season_id=$1
</span></span><span id="60" class="l"><a class="l" href="#60"> 60: </a><span class="php-quote">        ORDER BY preference ASC)) AS requested_durations,
</span></span><span id="61" class="l"><a class="l" href="#61"> 61: </a><span class="php-quote">      (SELECT array(SELECT show_season_timeslot_id FROM schedule.show_season_timeslot WHERE show_season_id=$1
</span></span><span id="62" class="l"><a class="l" href="#62"> 62: </a><span class="php-quote">        ORDER BY start_time ASC)) AS timeslots,
</span></span><span id="63" class="l"><a class="l" href="#63"> 63: </a><span class="php-quote">      (SELECT array(SELECT week FROM schedule.show_season_requested_week WHERE show_season_id=$1)) AS requested_weeks,
</span></span><span id="64" class="l"><a class="l" href="#64"> 64: </a><span class="php-quote">      (SELECT COUNT(*) FROM schedule.show_season
</span></span><span id="65" class="l"><a class="l" href="#65"> 65: </a><span class="php-quote">        WHERE show_id=(SELECT show_id FROM schedule.show_season WHERE show_season_id=$1) AND show_season_id&lt;=$1
</span></span><span id="66" class="l"><a class="l" href="#66"> 66: </a><span class="php-quote">          AND show_season_id IN (SELECT show_season_id FROM schedule.show_season_timeslot)) AS season_num
</span></span><span id="67" class="l"><a class="l" href="#67"> 67: </a><span class="php-quote">      FROM schedule.show_season WHERE show_season_id=$1'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$season_id</span>));
</span><span id="68" class="l"><a class="l" href="#68"> 68: </a>    <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$result</span>)) {
</span><span id="69" class="l"><a class="l" href="#69"> 69: </a>      <span class="php-comment">//Invalid Season</span>
</span><span id="70" class="l"><a class="l" href="#70"> 70: </a>      <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'The MyURY_Season with instance ID #'</span> . <span class="php-var">$season_id</span> . <span class="php-quote">' does not exist.'</span>);
</span><span id="71" class="l"><a class="l" href="#71"> 71: </a>    }
</span><span id="72" class="l"><a class="l" href="#72"> 72: </a>
</span><span id="73" class="l"><a class="l" href="#73"> 73: </a>    <span class="php-comment">//Deal with the easy bits</span>
</span><span id="74" class="l"><a class="l" href="#74"> 74: </a>    <span class="php-var">$this</span>-&gt;owner = User::getInstance(<span class="php-var">$result</span>[<span class="php-quote">'memberid'</span>]);
</span><span id="75" class="l"><a class="l" href="#75"> 75: </a>    <span class="php-var">$this</span>-&gt;show_id = (int) <span class="php-var">$result</span>[<span class="php-quote">'show_id'</span>];
</span><span id="76" class="l"><a class="l" href="#76"> 76: </a>    <span class="php-var">$this</span>-&gt;submitted = <span class="php-keyword2">strtotime</span>(<span class="php-var">$result</span>[<span class="php-quote">'submitted'</span>]);
</span><span id="77" class="l"><a class="l" href="#77"> 77: </a>    <span class="php-var">$this</span>-&gt;term_id = (int) <span class="php-var">$result</span>[<span class="php-quote">'termid'</span>];
</span><span id="78" class="l"><a class="l" href="#78"> 78: </a>    <span class="php-var">$this</span>-&gt;season_num = (int) <span class="php-var">$result</span>[<span class="php-quote">'season_num'</span>];
</span><span id="79" class="l"><a class="l" href="#79"> 79: </a>
</span><span id="80" class="l"><a class="l" href="#80"> 80: </a>    <span class="php-var">$metadata_types</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'metadata_types'</span>]);
</span><span id="81" class="l"><a class="l" href="#81"> 81: </a>    <span class="php-var">$metadata</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'metadata'</span>]);
</span><span id="82" class="l"><a class="l" href="#82"> 82: </a>    <span class="php-comment">//Deal with the metadata</span>
</span><span id="83" class="l"><a class="l" href="#83"> 83: </a>    <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-keyword2">sizeof</span>(<span class="php-var">$metadata_types</span>); <span class="php-var">$i</span>++) {
</span><span id="84" class="l"><a class="l" href="#84"> 84: </a>      <span class="php-keyword1">if</span> (self::isMetadataMultiple(<span class="php-var">$metadata_types</span>[<span class="php-var">$i</span>])) {
</span><span id="85" class="l"><a class="l" href="#85"> 85: </a>        <span class="php-var">$this</span>-&gt;metadata[<span class="php-var">$metadata_types</span>[<span class="php-var">$i</span>]][] = <span class="php-var">$metadata</span>[<span class="php-var">$i</span>];
</span><span id="86" class="l"><a class="l" href="#86"> 86: </a>      } <span class="php-keyword1">else</span> {
</span><span id="87" class="l"><a class="l" href="#87"> 87: </a>        <span class="php-var">$this</span>-&gt;metadata[<span class="php-var">$metadata_types</span>[<span class="php-var">$i</span>]] = <span class="php-var">$metadata</span>[<span class="php-var">$i</span>];
</span><span id="88" class="l"><a class="l" href="#88"> 88: </a>      }
</span><span id="89" class="l"><a class="l" href="#89"> 89: </a>    }
</span><span id="90" class="l"><a class="l" href="#90"> 90: </a>
</span><span id="91" class="l"><a class="l" href="#91"> 91: </a>    <span class="php-comment">//Requested Weeks</span>
</span><span id="92" class="l"><a class="l" href="#92"> 92: </a>    <span class="php-var">$requested_weeks</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'requested_weeks'</span>]);
</span><span id="93" class="l"><a class="l" href="#93"> 93: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$requested_weeks</span> <span class="php-keyword1">as</span> <span class="php-var">$requested_week</span>) {
</span><span id="94" class="l"><a class="l" href="#94"> 94: </a>      <span class="php-var">$this</span>-&gt;requested_weeks[] = <span class="php-keyword2">intval</span>(<span class="php-var">$requested_week</span>);
</span><span id="95" class="l"><a class="l" href="#95"> 95: </a>    }
</span><span id="96" class="l"><a class="l" href="#96"> 96: </a>
</span><span id="97" class="l"><a class="l" href="#97"> 97: </a>    <span class="php-comment">//Requested timeslots</span>
</span><span id="98" class="l"><a class="l" href="#98"> 98: </a>    <span class="php-var">$requested_days</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'requested_days'</span>]);
</span><span id="99" class="l"><a class="l" href="#99"> 99: </a>    <span class="php-var">$requested_start_times</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'requested_start_times'</span>]);
</span><span id="100" class="l"><a class="l" href="#100">100: </a>    <span class="php-var">$requested_durations</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'requested_durations'</span>]);
</span><span id="101" class="l"><a class="l" href="#101">101: </a>
</span><span id="102" class="l"><a class="l" href="#102">102: </a>    <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-keyword2">sizeof</span>(<span class="php-var">$requested_days</span>); <span class="php-var">$i</span>++) {
</span><span id="103" class="l"><a class="l" href="#103">103: </a>      <span class="php-var">$this</span>-&gt;requested_times[] = <span class="php-keyword1">array</span>(
</span><span id="104" class="l"><a class="l" href="#104">104: </a>          <span class="php-quote">'day'</span> =&gt; (int) <span class="php-var">$requested_days</span>[<span class="php-var">$i</span>],
</span><span id="105" class="l"><a class="l" href="#105">105: </a>          <span class="php-quote">'start_time'</span> =&gt; (int) <span class="php-var">$requested_start_times</span>[<span class="php-var">$i</span>],
</span><span id="106" class="l"><a class="l" href="#106">106: </a>          <span class="php-quote">'duration'</span> =&gt; self::<span class="php-var">$db</span>-&gt;intervalToTime(<span class="php-var">$requested_durations</span>[<span class="php-var">$i</span>])
</span><span id="107" class="l"><a class="l" href="#107">107: </a>      );
</span><span id="108" class="l"><a class="l" href="#108">108: </a>    }
</span><span id="109" class="l"><a class="l" href="#109">109: </a>
</span><span id="110" class="l"><a class="l" href="#110">110: </a>    <span class="php-comment">//And now initiate timeslots</span>
</span><span id="111" class="l"><a class="l" href="#111">111: </a>    <span class="php-var">$timeslots</span> = self::<span class="php-var">$db</span>-&gt;decodeArray(<span class="php-var">$result</span>[<span class="php-quote">'timeslots'</span>]);
</span><span id="112" class="l"><a class="l" href="#112">112: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$timeslots</span> <span class="php-keyword1">as</span> <span class="php-var">$timeslot</span>) {
</span><span id="113" class="l"><a class="l" href="#113">113: </a>      <span class="php-var">$this</span>-&gt;timeslots[] = MyURY_Timeslot::getInstance(<span class="php-var">$timeslot</span>);
</span><span id="114" class="l"><a class="l" href="#114">114: </a>    }
</span><span id="115" class="l"><a class="l" href="#115">115: </a>  }
</span><span id="116" class="l"><a class="l" href="#116">116: </a>
</span><span id="117" class="l"><a class="l" href="#117">117: </a>  <span class="php-comment">/**
</span></span><span id="118" class="l"><a class="l" href="#118">118: </a><span class="php-comment">   * Creates a new MyURY Season Application and returns an object representing it
</span></span><span id="119" class="l"><a class="l" href="#119">119: </a><span class="php-comment">   * @param Array $params An array of Seasons properties compatible with the Models/Scheduler/seasonfrm Form,
</span></span><span id="120" class="l"><a class="l" href="#120">120: </a><span class="php-comment">   * with a few additional potential customisation options:
</span></span><span id="121" class="l"><a class="l" href="#121">121: </a><span class="php-comment">   * weeks: An Array of weeks, keyed wk1-10, representing the requested week&lt;br&gt;
</span></span><span id="122" class="l"><a class="l" href="#122">122: </a><span class="php-comment">   * day: An Array of one or more requested days, 0 being Monday, 6 being Sunday. Corresponds to (s|e)time&lt;br&gt;
</span></span><span id="123" class="l"><a class="l" href="#123">123: </a><span class="php-comment">   * stime: An Array of sizeof(day) times, represeting the time of day the show should start&lt;br&gt;
</span></span><span id="124" class="l"><a class="l" href="#124">124: </a><span class="php-comment">   * etime: An Array of sizeof(day) times, represeting the time of day the show should end&lt;br&gt;
</span></span><span id="125" class="l"><a class="l" href="#125">125: </a><span class="php-comment">   * description: A description of this Season of the Show, in addition to the Show description&lt;br&gt;
</span></span><span id="126" class="l"><a class="l" href="#126">126: </a><span class="php-comment">   * tags: A string of 0 or more space-seperated tags this Season relates to, in addition to the Show tags&lt;br&gt;
</span></span><span id="127" class="l"><a class="l" href="#127">127: </a><span class="php-comment">   * show_id: The ID of the Show to assign the application to
</span></span><span id="128" class="l"><a class="l" href="#128">128: </a><span class="php-comment">   * termid: The ID of the term being applied for. Defaults to the current Term
</span></span><span id="129" class="l"><a class="l" href="#129">129: </a><span class="php-comment">   * 
</span></span><span id="130" class="l"><a class="l" href="#130">130: </a><span class="php-comment">   * weeks, day, stime, etime, show_id are all required fields
</span></span><span id="131" class="l"><a class="l" href="#131">131: </a><span class="php-comment">   * 
</span></span><span id="132" class="l"><a class="l" href="#132">132: </a><span class="php-comment">   * As this is the initial creation, all tags are &lt;i&gt;approved&lt;/i&gt; by the submitted so the show has some initial values
</span></span><span id="133" class="l"><a class="l" href="#133">133: </a><span class="php-comment">   * 
</span></span><span id="134" class="l"><a class="l" href="#134">134: </a><span class="php-comment">   * @throws MyURYException
</span></span><span id="135" class="l"><a class="l" href="#135">135: </a><span class="php-comment">   */</span>
</span><span id="136" class="l"><a class="l" href="#136">136: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a id="_apply" href="#_apply">apply</a>(<span class="php-var">$params</span> = <span class="php-keyword1">array</span>()) {
</span><span id="137" class="l"><a class="l" href="#137">137: </a>    <span class="php-comment">//Validate input</span>
</span><span id="138" class="l"><a class="l" href="#138">138: </a>    <span class="php-var">$required</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'show_id'</span>, <span class="php-quote">'weeks'</span>, <span class="php-quote">'day'</span>, <span class="php-quote">'stime'</span>, <span class="php-quote">'etime'</span>);
</span><span id="139" class="l"><a class="l" href="#139">139: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$required</span> <span class="php-keyword1">as</span> <span class="php-var">$field</span>) {
</span><span id="140" class="l"><a class="l" href="#140">140: </a>      <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$params</span>[<span class="php-var">$field</span>])) {
</span><span id="141" class="l"><a class="l" href="#141">141: </a>        <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'Parameter '</span> . <span class="php-var">$field</span> . <span class="php-quote">' was not provided.'</span>, MyURYException::FATAL);
</span><span id="142" class="l"><a class="l" href="#142">142: </a>      }
</span><span id="143" class="l"><a class="l" href="#143">143: </a>    }
</span><span id="144" class="l"><a class="l" href="#144">144: </a>
</span><span id="145" class="l"><a class="l" href="#145">145: </a>    self::initDB();
</span><span id="146" class="l"><a class="l" href="#146">146: </a>
</span><span id="147" class="l"><a class="l" href="#147">147: </a>    <span class="php-comment">/**
</span></span><span id="148" class="l"><a class="l" href="#148">148: </a><span class="php-comment">     * @todo Perform required checks:
</span></span><span id="149" class="l"><a class="l" href="#149">149: </a><span class="php-comment">     * Show ID is a valid Show of the Show Type
</span></span><span id="150" class="l"><a class="l" href="#150">150: </a><span class="php-comment">     * All keys of weeks between 1 and 10 are defined and boolean (set to false if not defined)
</span></span><span id="151" class="l"><a class="l" href="#151">151: </a><span class="php-comment">     * All values of day are between 0 and 6
</span></span><span id="152" class="l"><a class="l" href="#152">152: </a><span class="php-comment">     * All values of stime and etime are between 0 and 86399
</span></span><span id="153" class="l"><a class="l" href="#153">153: </a><span class="php-comment">     * Select an appropriate value for $term_id
</span></span><span id="154" class="l"><a class="l" href="#154">154: </a><span class="php-comment">     */</span>
</span><span id="155" class="l"><a class="l" href="#155">155: </a>    <span class="php-var">$term_id</span> = self::getActiveApplicationTerm();
</span><span id="156" class="l"><a class="l" href="#156">156: </a>
</span><span id="157" class="l"><a class="l" href="#157">157: </a>    <span class="php-comment">//Start a transaction</span>
</span><span id="158" class="l"><a class="l" href="#158">158: </a>    self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'BEGIN'</span>);
</span><span id="159" class="l"><a class="l" href="#159">159: </a>
</span><span id="160" class="l"><a class="l" href="#160">160: </a>    <span class="php-comment">//Right, let's start by getting a Season ID created for this entry</span>
</span><span id="161" class="l"><a class="l" href="#161">161: </a>    <span class="php-var">$season_create_result</span> = self::<span class="php-var">$db</span>-&gt;fetch_column(<span class="php-quote">'INSERT INTO schedule.show_season (show_id, termid, submitted, memberid)
</span></span><span id="162" class="l"><a class="l" href="#162">162: </a><span class="php-quote">      VALUES ($1, $2, $3, $4) RETURNING show_season_id'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$params</span>[<span class="php-quote">'show_id'</span>], <span class="php-var">$term_id</span>, CoreUtils::getTimestamp(), User::getInstance()-&gt;getID()), <span class="php-keyword1">true</span>);
</span><span id="163" class="l"><a class="l" href="#163">163: </a>
</span><span id="164" class="l"><a class="l" href="#164">164: </a>    <span class="php-var">$season_id</span> = <span class="php-var">$season_create_result</span>[<span class="php-num">0</span>];
</span><span id="165" class="l"><a class="l" href="#165">165: </a>
</span><span id="166" class="l"><a class="l" href="#166">166: </a>    <span class="php-comment">//Now let's allocate store the requested weeks for a term</span>
</span><span id="167" class="l"><a class="l" href="#167">167: </a>    <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt;= <span class="php-num">10</span>; <span class="php-var">$i</span>++) {
</span><span id="168" class="l"><a class="l" href="#168">168: </a>      <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'weeks'</span>][<span class="php-quote">&quot;wk</span><span class="php-var">$i</span><span class="php-quote">&quot;</span>]) {
</span><span id="169" class="l"><a class="l" href="#169">169: </a>        self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'INSERT INTO schedule.show_season_requested_week (show_season_id, week) VALUES ($1, $2)'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$season_id</span>, <span class="php-var">$i</span>), <span class="php-keyword1">true</span>);
</span><span id="170" class="l"><a class="l" href="#170">170: </a>      }
</span><span id="171" class="l"><a class="l" href="#171">171: </a>    }
</span><span id="172" class="l"><a class="l" href="#172">172: </a>
</span><span id="173" class="l"><a class="l" href="#173">173: </a>    <span class="php-comment">//Now for requested times</span>
</span><span id="174" class="l"><a class="l" href="#174">174: </a>    <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-keyword2">sizeof</span>(<span class="php-var">$params</span>[<span class="php-quote">'day'</span>]); <span class="php-var">$i</span>++) {
</span><span id="175" class="l"><a class="l" href="#175">175: </a>      <span class="php-comment">//Deal with the possibility of a show from 11pm to midnight etc.</span>
</span><span id="176" class="l"><a class="l" href="#176">176: </a>      <span class="php-comment">/**
</span></span><span id="177" class="l"><a class="l" href="#177">177: </a><span class="php-comment">       * @todo make this not be completely stupid
</span></span><span id="178" class="l"><a class="l" href="#178">178: </a><span class="php-comment">       */</span>
</span><span id="179" class="l"><a class="l" href="#179">179: </a>      <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'stime'</span>][<span class="php-var">$i</span>] &lt; <span class="php-var">$params</span>[<span class="php-quote">'etime'</span>][<span class="php-var">$i</span>]) {
</span><span id="180" class="l"><a class="l" href="#180">180: </a>        <span class="php-var">$interval</span> = CoreUtils::makeInterval(<span class="php-var">$params</span>[<span class="php-quote">'stime'</span>][<span class="php-var">$i</span>], <span class="php-var">$params</span>[<span class="php-quote">'etime'</span>][<span class="php-var">$i</span>]);
</span><span id="181" class="l"><a class="l" href="#181">181: </a>      } <span class="php-keyword1">else</span> {
</span><span id="182" class="l"><a class="l" href="#182">182: </a>        <span class="php-var">$interval</span> = CoreUtils::makeInterval(<span class="php-var">$params</span>[<span class="php-quote">'stime'</span>][<span class="php-var">$i</span>], <span class="php-var">$params</span>[<span class="php-quote">'etime'</span>][<span class="php-var">$i</span>] + <span class="php-num">86400</span>);
</span><span id="183" class="l"><a class="l" href="#183">183: </a>      }
</span><span id="184" class="l"><a class="l" href="#184">184: </a>
</span><span id="185" class="l"><a class="l" href="#185">185: </a>      <span class="php-comment">//Enter the data</span>
</span><span id="186" class="l"><a class="l" href="#186">186: </a>      self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'INSERT INTO schedule.show_season_requested_time 
</span></span><span id="187" class="l"><a class="l" href="#187">187: </a><span class="php-quote">        (requested_day, start_time, preference, duration, show_season_id) VALUES ($1, $2, $3, $4, $5)'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$params</span>[<span class="php-quote">'day'</span>][<span class="php-var">$i</span>], <span class="php-var">$params</span>[<span class="php-quote">'stime'</span>][<span class="php-var">$i</span>], <span class="php-var">$i</span>, <span class="php-var">$interval</span>, <span class="php-var">$season_id</span>));
</span><span id="188" class="l"><a class="l" href="#188">188: </a>    }
</span><span id="189" class="l"><a class="l" href="#189">189: </a>
</span><span id="190" class="l"><a class="l" href="#190">190: </a>    <span class="php-comment">//If the description metadata is non-blank, then update that too</span>
</span><span id="191" class="l"><a class="l" href="#191">191: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>[<span class="php-quote">'description'</span>])) {
</span><span id="192" class="l"><a class="l" href="#192">192: </a>      self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'INSERT INTO schedule.season_metadata
</span></span><span id="193" class="l"><a class="l" href="#193">193: </a><span class="php-quote">        (metadata_key_id, show_season_id, metadata_value, effective_from, memberid, approvedid) VALUES
</span></span><span id="194" class="l"><a class="l" href="#194">194: </a><span class="php-quote">        ($1, $2, $3, NOW(), $4, $4)'</span>, <span class="php-keyword1">array</span>(
</span><span id="195" class="l"><a class="l" href="#195">195: </a>          self::getMetadataKey(<span class="php-quote">'description'</span>), <span class="php-var">$season_id</span>, <span class="php-var">$params</span>[<span class="php-quote">'description'</span>], <span class="php-var">$_SESSION</span>[<span class="php-quote">'memberid'</span>]
</span><span id="196" class="l"><a class="l" href="#196">196: </a>              ), <span class="php-keyword1">true</span>);
</span><span id="197" class="l"><a class="l" href="#197">197: </a>    }
</span><span id="198" class="l"><a class="l" href="#198">198: </a>
</span><span id="199" class="l"><a class="l" href="#199">199: </a>    <span class="php-comment">//Same with tags</span>
</span><span id="200" class="l"><a class="l" href="#200">200: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>[<span class="php-quote">'tags'</span>])) {
</span><span id="201" class="l"><a class="l" href="#201">201: </a>      <span class="php-var">$tags</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">' '</span>, <span class="php-var">$params</span>[<span class="php-quote">'tags'</span>]);
</span><span id="202" class="l"><a class="l" href="#202">202: </a>      <span class="php-keyword1">foreach</span> (<span class="php-var">$tags</span> <span class="php-keyword1">as</span> <span class="php-var">$tag</span>) {
</span><span id="203" class="l"><a class="l" href="#203">203: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$tag</span>))
</span><span id="204" class="l"><a class="l" href="#204">204: </a>          <span class="php-keyword1">continue</span>;
</span><span id="205" class="l"><a class="l" href="#205">205: </a>        self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'INSERT INTO schedule.season_metadata
</span></span><span id="206" class="l"><a class="l" href="#206">206: </a><span class="php-quote">          (metadata_key_id, show_season_id, metadata_value, effective_from, memberid, approvedid) VALUES
</span></span><span id="207" class="l"><a class="l" href="#207">207: </a><span class="php-quote">          ($1, $2, $3, NOW(), $4, $4)'</span>, <span class="php-keyword1">array</span>(
</span><span id="208" class="l"><a class="l" href="#208">208: </a>            self::getMetadataKey(<span class="php-quote">'tag'</span>), <span class="php-var">$season_id</span>, <span class="php-var">$tag</span>, <span class="php-var">$_SESSION</span>[<span class="php-quote">'memberid'</span>]
</span><span id="209" class="l"><a class="l" href="#209">209: </a>                ), <span class="php-keyword1">true</span>);
</span><span id="210" class="l"><a class="l" href="#210">210: </a>      }
</span><span id="211" class="l"><a class="l" href="#211">211: </a>    }
</span><span id="212" class="l"><a class="l" href="#212">212: </a>
</span><span id="213" class="l"><a class="l" href="#213">213: </a>    <span class="php-comment">//Actually commit the show to the database!</span>
</span><span id="214" class="l"><a class="l" href="#214">214: </a>    self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'COMMIT'</span>);
</span><span id="215" class="l"><a class="l" href="#215">215: </a>
</span><span id="216" class="l"><a class="l" href="#216">216: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> self(<span class="php-var">$season_id</span>);
</span><span id="217" class="l"><a class="l" href="#217">217: </a>  }
</span><span id="218" class="l"><a class="l" href="#218">218: </a>
</span><span id="219" class="l"><a class="l" href="#219">219: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getMeta" href="#_getMeta">getMeta</a>(<span class="php-var">$meta_string</span>) {
</span><span id="220" class="l"><a class="l" href="#220">220: </a>    <span class="php-var">$key</span> = self::getMetadataKey(<span class="php-var">$meta_string</span>);
</span><span id="221" class="l"><a class="l" href="#221">221: </a>    <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;meta[<span class="php-var">$key</span>])) {
</span><span id="222" class="l"><a class="l" href="#222">222: </a>      <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;meta[<span class="php-var">$key</span>];
</span><span id="223" class="l"><a class="l" href="#223">223: </a>    } <span class="php-keyword1">else</span> {
</span><span id="224" class="l"><a class="l" href="#224">224: </a>      <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getShow()-&gt;getMeta(<span class="php-var">$meta_string</span>);
</span><span id="225" class="l"><a class="l" href="#225">225: </a>    }
</span><span id="226" class="l"><a class="l" href="#226">226: </a>  }
</span><span id="227" class="l"><a class="l" href="#227">227: </a>
</span><span id="228" class="l"><a class="l" href="#228">228: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getID" href="#_getID">getID</a>() {
</span><span id="229" class="l"><a class="l" href="#229">229: </a>    <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;season_id;
</span><span id="230" class="l"><a class="l" href="#230">230: </a>  }
</span><span id="231" class="l"><a class="l" href="#231">231: </a>
</span><span id="232" class="l"><a class="l" href="#232">232: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getShow" href="#_getShow">getShow</a>() {
</span><span id="233" class="l"><a class="l" href="#233">233: </a>    <span class="php-keyword1">return</span> MyURY_Show::getInstance(<span class="php-var">$this</span>-&gt;show_id);
</span><span id="234" class="l"><a class="l" href="#234">234: </a>  }
</span><span id="235" class="l"><a class="l" href="#235">235: </a>
</span><span id="236" class="l"><a class="l" href="#236">236: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getSubmittedTime" href="#_getSubmittedTime">getSubmittedTime</a>() {
</span><span id="237" class="l"><a class="l" href="#237">237: </a>    <span class="php-keyword1">return</span> CoreUtils::happyTime(<span class="php-var">$this</span>-&gt;submitted);
</span><span id="238" class="l"><a class="l" href="#238">238: </a>  }
</span><span id="239" class="l"><a class="l" href="#239">239: </a>
</span><span id="240" class="l"><a class="l" href="#240">240: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getWebpage" href="#_getWebpage">getWebpage</a>() {
</span><span id="241" class="l"><a class="l" href="#241">241: </a>    <span class="php-keyword1">return</span> <span class="php-quote">'http://ury.org.uk/show/'</span> . <span class="php-var">$this</span>-&gt;getShow()-&gt;getID() . <span class="php-quote">'/'</span> . <span class="php-var">$this</span>-&gt;getID();
</span><span id="242" class="l"><a class="l" href="#242">242: </a>  }
</span><span id="243" class="l"><a class="l" href="#243">243: </a>
</span><span id="244" class="l"><a class="l" href="#244">244: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getRequestedTimes" href="#_getRequestedTimes">getRequestedTimes</a>() {
</span><span id="245" class="l"><a class="l" href="#245">245: </a>    <span class="php-var">$return</span> = <span class="php-keyword1">array</span>();
</span><span id="246" class="l"><a class="l" href="#246">246: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;requested_times <span class="php-keyword1">as</span> <span class="php-var">$time</span>) {
</span><span id="247" class="l"><a class="l" href="#247">247: </a>      <span class="php-var">$return</span>[] = self::formatTimeHuman(<span class="php-var">$time</span>);
</span><span id="248" class="l"><a class="l" href="#248">248: </a>    }
</span><span id="249" class="l"><a class="l" href="#249">249: </a>    <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span id="250" class="l"><a class="l" href="#250">250: </a>  }
</span><span id="251" class="l"><a class="l" href="#251">251: </a>
</span><span id="252" class="l"><a class="l" href="#252">252: </a>  <span class="php-comment">/**
</span></span><span id="253" class="l"><a class="l" href="#253">253: </a><span class="php-comment">   * Returns a 2D array:
</span></span><span id="254" class="l"><a class="l" href="#254">254: </a><span class="php-comment">   * time: Value as per getRequestedTimes()
</span></span><span id="255" class="l"><a class="l" href="#255">255: </a><span class="php-comment">   * conflict: True if one or more of requested weeks already have a booking that time
</span></span><span id="256" class="l"><a class="l" href="#256">256: </a><span class="php-comment">   * info: If True above, will have human-readable why-it-is-a-conflict details. It may also contain information about
</span></span><span id="257" class="l"><a class="l" href="#257">257: </a><span class="php-comment">   * &quot;warnings&quot; - conflicts on weeks this show isn't planned to be aired
</span></span><span id="258" class="l"><a class="l" href="#258">258: </a><span class="php-comment">   * @todo The Warnings part above
</span></span><span id="259" class="l"><a class="l" href="#259">259: </a><span class="php-comment">   * @todo Discuss efficiency of this algorithm
</span></span><span id="260" class="l"><a class="l" href="#260">260: </a><span class="php-comment">   */</span>
</span><span id="261" class="l"><a class="l" href="#261">261: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getRequestedTimesAvail" href="#_getRequestedTimesAvail">getRequestedTimesAvail</a>() {
</span><span id="262" class="l"><a class="l" href="#262">262: </a>    <span class="php-var">$return</span> = <span class="php-keyword1">array</span>();
</span><span id="263" class="l"><a class="l" href="#263">263: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;requested_times <span class="php-keyword1">as</span> <span class="php-var">$time</span>) {
</span><span id="264" class="l"><a class="l" href="#264">264: </a>      <span class="php-comment">//Check for existence of shows in requested times</span>
</span><span id="265" class="l"><a class="l" href="#265">265: </a>      <span class="php-var">$conflicts</span> = self::getScheduleConflicts(<span class="php-var">$this</span>-&gt;term_id, <span class="php-var">$time</span>);
</span><span id="266" class="l"><a class="l" href="#266">266: </a>      <span class="php-var">$warnings</span> = <span class="php-keyword1">array</span>();
</span><span id="267" class="l"><a class="l" href="#267">267: </a>      <span class="php-keyword1">foreach</span> (<span class="php-var">$conflicts</span> <span class="php-keyword1">as</span> <span class="php-var">$wk</span> =&gt; <span class="php-var">$sid</span>) {
</span><span id="268" class="l"><a class="l" href="#268">268: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$wk</span>, <span class="php-var">$conflicts</span>)) {
</span><span id="269" class="l"><a class="l" href="#269">269: </a>          <span class="php-comment">//This isn't actually a conflict because the week isn't requested by the user</span>
</span><span id="270" class="l"><a class="l" href="#270">270: </a>          <span class="php-var">$warnings</span>[<span class="php-var">$wk</span>] = <span class="php-var">$sid</span>;
</span><span id="271" class="l"><a class="l" href="#271">271: </a>          <span class="php-keyword1">unset</span>(<span class="php-var">$conflicts</span>[<span class="php-var">$wk</span>]);
</span><span id="272" class="l"><a class="l" href="#272">272: </a>        }
</span><span id="273" class="l"><a class="l" href="#273">273: </a>      }
</span><span id="274" class="l"><a class="l" href="#274">274: </a>      <span class="php-comment">//If there's a any conflicts, let's make the nice explanation</span>
</span><span id="275" class="l"><a class="l" href="#275">275: </a>      <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$conflicts</span>)) {
</span><span id="276" class="l"><a class="l" href="#276">276: </a>        <span class="php-var">$names</span> = <span class="php-quote">''</span>;
</span><span id="277" class="l"><a class="l" href="#277">277: </a>        <span class="php-var">$weeks</span> = <span class="php-quote">' on weeks '</span>;
</span><span id="278" class="l"><a class="l" href="#278">278: </a>        <span class="php-var">$week_num</span> = -<span class="php-num">10</span>;
</span><span id="279" class="l"><a class="l" href="#279">279: </a>        <span class="php-comment">//Count the number of conflicts with season ids</span>
</span><span id="280" class="l"><a class="l" href="#280">280: </a>        <span class="php-var">$sids</span> = <span class="php-keyword1">array</span>();
</span><span id="281" class="l"><a class="l" href="#281">281: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$conflicts</span> <span class="php-keyword1">as</span> <span class="php-var">$k</span> =&gt; <span class="php-var">$v</span>) {
</span><span id="282" class="l"><a class="l" href="#282">282: </a>          <span class="php-comment">/**
</span></span><span id="283" class="l"><a class="l" href="#283">283: </a><span class="php-comment">           * @todo - figure out why this loop includes 0 and 11 sometimes
</span></span><span id="284" class="l"><a class="l" href="#284">284: </a><span class="php-comment">           * @todo Work on weeks text output - duplicates/overlaps
</span></span><span id="285" class="l"><a class="l" href="#285">285: </a><span class="php-comment">           */</span>
</span><span id="286" class="l"><a class="l" href="#286">286: </a>          <span class="php-keyword1">if</span> (<span class="php-var">$k</span> &gt; <span class="php-num">10</span> || <span class="php-var">$k</span> &lt; <span class="php-num">1</span>)
</span><span id="287" class="l"><a class="l" href="#287">287: </a>            <span class="php-keyword1">continue</span>;
</span><span id="288" class="l"><a class="l" href="#288">288: </a>          <span class="php-var">$sids</span>[<span class="php-var">$v</span>]++;
</span><span id="289" class="l"><a class="l" href="#289">289: </a>          <span class="php-comment">//Work out blocked weeks</span>
</span><span id="290" class="l"><a class="l" href="#290">290: </a>          <span class="php-keyword1">if</span> (<span class="php-var">$k</span> == ++<span class="php-var">$week_num</span>) {
</span><span id="291" class="l"><a class="l" href="#291">291: </a>            <span class="php-comment">//Continuation of previous sequence</span>
</span><span id="292" class="l"><a class="l" href="#292">292: </a>            <span class="php-var">$week_num</span> = <span class="php-var">$k</span>;
</span><span id="293" class="l"><a class="l" href="#293">293: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$k</span> == <span class="php-num">10</span>)
</span><span id="294" class="l"><a class="l" href="#294">294: </a>              <span class="php-var">$weeks</span> .= <span class="php-quote">'-10'</span>;
</span><span id="295" class="l"><a class="l" href="#295">295: </a>          } <span class="php-keyword1">else</span> {
</span><span id="296" class="l"><a class="l" href="#296">296: </a>            <span class="php-comment">//New sequence</span>
</span><span id="297" class="l"><a class="l" href="#297">297: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$week_num</span> &gt; <span class="php-num">0</span>)
</span><span id="298" class="l"><a class="l" href="#298">298: </a>              <span class="php-var">$weeks</span> .= <span class="php-quote">'-'</span> . <span class="php-var">$week_num</span> . <span class="php-quote">', '</span>;
</span><span id="299" class="l"><a class="l" href="#299">299: </a>            <span class="php-var">$weeks</span> .= <span class="php-var">$k</span>;
</span><span id="300" class="l"><a class="l" href="#300">300: </a>            <span class="php-var">$week_num</span> = <span class="php-var">$k</span>;
</span><span id="301" class="l"><a class="l" href="#301">301: </a>          }
</span><span id="302" class="l"><a class="l" href="#302">302: </a>        }
</span><span id="303" class="l"><a class="l" href="#303">303: </a>        <span class="php-comment">//Iterate over every conflicted show and log</span>
</span><span id="304" class="l"><a class="l" href="#304">304: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$sids</span> <span class="php-keyword1">as</span> <span class="php-var">$k</span> =&gt; <span class="php-var">$v</span>) {
</span><span id="305" class="l"><a class="l" href="#305">305: </a>          <span class="php-comment">//Get the show name and store it</span>
</span><span id="306" class="l"><a class="l" href="#306">306: </a>          <span class="php-keyword1">if</span> (<span class="php-var">$names</span> !== <span class="php-quote">''</span>)
</span><span id="307" class="l"><a class="l" href="#307">307: </a>            <span class="php-var">$names</span> .= <span class="php-quote">', '</span>;
</span><span id="308" class="l"><a class="l" href="#308">308: </a>          <span class="php-var">$names</span> .= self::getInstance(<span class="php-var">$k</span>)-&gt;getMeta(<span class="php-quote">'title'</span>);
</span><span id="309" class="l"><a class="l" href="#309">309: </a>        }
</span><span id="310" class="l"><a class="l" href="#310">310: </a>        <span class="php-var">$return</span>[] = <span class="php-keyword1">array</span>(<span class="php-quote">'time'</span> =&gt; self::formatTimeHuman(<span class="php-var">$time</span>), <span class="php-quote">'conflict'</span> =&gt; <span class="php-keyword1">true</span>, <span class="php-quote">'info'</span> =&gt; <span class="php-quote">'Conflicts with '</span> . <span class="php-var">$names</span> . <span class="php-var">$weeks</span>);
</span><span id="311" class="l"><a class="l" href="#311">311: </a>      } <span class="php-keyword1">else</span> {
</span><span id="312" class="l"><a class="l" href="#312">312: </a>        <span class="php-comment">//No conflicts</span>
</span><span id="313" class="l"><a class="l" href="#313">313: </a>        <span class="php-var">$return</span>[] = <span class="php-keyword1">array</span>(<span class="php-quote">'time'</span> =&gt; self::formatTimeHuman(<span class="php-var">$time</span>), <span class="php-quote">'conflict'</span> =&gt; <span class="php-keyword1">false</span>, <span class="php-quote">'info'</span> =&gt; <span class="php-quote">''</span>);
</span><span id="314" class="l"><a class="l" href="#314">314: </a>      }
</span><span id="315" class="l"><a class="l" href="#315">315: </a>    }
</span><span id="316" class="l"><a class="l" href="#316">316: </a>    <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span id="317" class="l"><a class="l" href="#317">317: </a>  }
</span><span id="318" class="l"><a class="l" href="#318">318: </a>
</span><span id="319" class="l"><a class="l" href="#319">319: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getRequestedWeeks" href="#_getRequestedWeeks">getRequestedWeeks</a>() {
</span><span id="320" class="l"><a class="l" href="#320">320: </a>    <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;requested_weeks;
</span><span id="321" class="l"><a class="l" href="#321">321: </a>  }
</span><span id="322" class="l"><a class="l" href="#322">322: </a>
</span><span id="323" class="l"><a class="l" href="#323">323: </a>  <span class="php-comment">/**
</span></span><span id="324" class="l"><a class="l" href="#324">324: </a><span class="php-comment">   * Get the Season number - for the first season of a show, this is 1, for the second it's 2 etc.
</span></span><span id="325" class="l"><a class="l" href="#325">325: </a><span class="php-comment">   * Seasons that don't have any timeslots scheduled do not count toward this value.
</span></span><span id="326" class="l"><a class="l" href="#326">326: </a><span class="php-comment">   * @return int
</span></span><span id="327" class="l"><a class="l" href="#327">327: </a><span class="php-comment">   */</span>
</span><span id="328" class="l"><a class="l" href="#328">328: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getSeasonNumber" href="#_getSeasonNumber">getSeasonNumber</a>() {
</span><span id="329" class="l"><a class="l" href="#329">329: </a>    <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;season_num;
</span><span id="330" class="l"><a class="l" href="#330">330: </a>  }
</span><span id="331" class="l"><a class="l" href="#331">331: </a>
</span><span id="332" class="l"><a class="l" href="#332">332: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_toDataSource" href="#_toDataSource">toDataSource</a>() {
</span><span id="333" class="l"><a class="l" href="#333">333: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;getShow()-&gt;toDataSource(), <span class="php-keyword1">array</span>(
</span><span id="334" class="l"><a class="l" href="#334">334: </a>                <span class="php-quote">'id'</span> =&gt; <span class="php-var">$this</span>-&gt;getID(),
</span><span id="335" class="l"><a class="l" href="#335">335: </a>                <span class="php-quote">'season_num'</span> =&gt; <span class="php-var">$this</span>-&gt;getSeasonNumber(),
</span><span id="336" class="l"><a class="l" href="#336">336: </a>                <span class="php-quote">'title'</span> =&gt; <span class="php-var">$this</span>-&gt;getMeta(<span class="php-quote">'title'</span>),
</span><span id="337" class="l"><a class="l" href="#337">337: </a>                <span class="php-quote">'description'</span> =&gt; <span class="php-var">$this</span>-&gt;getMeta(<span class="php-quote">'description'</span>),
</span><span id="338" class="l"><a class="l" href="#338">338: </a>                <span class="php-quote">'submitted'</span> =&gt; <span class="php-var">$this</span>-&gt;getSubmittedTime(),
</span><span id="339" class="l"><a class="l" href="#339">339: </a>                <span class="php-quote">'requested_time'</span> =&gt; <span class="php-var">$this</span>-&gt;getRequestedTimes()[<span class="php-num">0</span>],
</span><span id="340" class="l"><a class="l" href="#340">340: </a>                <span class="php-quote">'first_time'</span> =&gt; (<span class="php-keyword2">is_object</span>(<span class="php-var">$this</span>-&gt;timeslots[<span class="php-num">0</span>]) ? CoreUtils::happyTime(<span class="php-var">$this</span>-&gt;timeslots[<span class="php-num">0</span>]-&gt;getStartTime()) : <span class="php-quote">'Not Scheduled'</span>),
</span><span id="341" class="l"><a class="l" href="#341">341: </a>                <span class="php-quote">'num_episodes'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="342" class="l"><a class="l" href="#342">342: </a>                    <span class="php-quote">'display'</span> =&gt; <span class="php-quote">'text'</span>,
</span><span id="343" class="l"><a class="l" href="#343">343: </a>                    <span class="php-quote">'value'</span> =&gt; <span class="php-keyword2">sizeof</span>(<span class="php-var">$this</span>-&gt;timeslots),
</span><span id="344" class="l"><a class="l" href="#344">344: </a>                    <span class="php-quote">'url'</span> =&gt; CoreUtils::makeURL(<span class="php-quote">'Scheduler'</span>, <span class="php-quote">'listTimeslots'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'show_season_id'</span> =&gt; <span class="php-var">$this</span>-&gt;getID()))),
</span><span id="345" class="l"><a class="l" href="#345">345: </a>                <span class="php-quote">'allocatelink'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="346" class="l"><a class="l" href="#346">346: </a>                    <span class="php-quote">'display'</span> =&gt; <span class="php-quote">'icon'</span>,
</span><span id="347" class="l"><a class="l" href="#347">347: </a>                    <span class="php-quote">'value'</span> =&gt; <span class="php-quote">'script'</span>,
</span><span id="348" class="l"><a class="l" href="#348">348: </a>                    <span class="php-quote">'title'</span> =&gt; <span class="php-quote">'Edit Application or Allocate Season'</span>,
</span><span id="349" class="l"><a class="l" href="#349">349: </a>                    <span class="php-quote">'url'</span> =&gt; CoreUtils::makeURL(<span class="php-quote">'Scheduler'</span>, <span class="php-quote">'allocate'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'show_season_id'</span> =&gt; <span class="php-var">$this</span>-&gt;getID()))),
</span><span id="350" class="l"><a class="l" href="#350">350: </a>                <span class="php-quote">'rejectlink'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="351" class="l"><a class="l" href="#351">351: </a>                    <span class="php-quote">'display'</span> =&gt; <span class="php-quote">'icon'</span>,
</span><span id="352" class="l"><a class="l" href="#352">352: </a>                    <span class="php-quote">'value'</span> =&gt; <span class="php-quote">'trash'</span>,
</span><span id="353" class="l"><a class="l" href="#353">353: </a>                    <span class="php-quote">'title'</span> =&gt; <span class="php-quote">'Reject Application'</span>,
</span><span id="354" class="l"><a class="l" href="#354">354: </a>                    <span class="php-quote">'url'</span> =&gt; CoreUtils::makeURL(<span class="php-quote">'Scheduler'</span>, <span class="php-quote">'reject'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'show_season_id'</span> =&gt; <span class="php-var">$this</span>-&gt;getID())))
</span><span id="355" class="l"><a class="l" href="#355">355: </a>            ));
</span><span id="356" class="l"><a class="l" href="#356">356: </a>  }
</span><span id="357" class="l"><a class="l" href="#357">357: </a>
</span><span id="358" class="l"><a class="l" href="#358">358: </a>  <span class="php-comment">/**
</span></span><span id="359" class="l"><a class="l" href="#359">359: </a><span class="php-comment">   * This is where some of the most important MyURY stuff happens.
</span></span><span id="360" class="l"><a class="l" href="#360">360: </a><span class="php-comment">   * This is where an application for a presenter's dreams become reality...
</span></span><span id="361" class="l"><a class="l" href="#361">361: </a><span class="php-comment">   * or get crushed to pieces.
</span></span><span id="362" class="l"><a class="l" href="#362">362: </a><span class="php-comment">   * @param Array $params key=&gt;value of the following parameters:
</span></span><span id="363" class="l"><a class="l" href="#363">363: </a><span class="php-comment">   * weeks: A key=&gt;value away of weeks and whether to schedule (wk1 =&gt; 0, wk1=&gt;1...)
</span></span><span id="364" class="l"><a class="l" href="#364">364: </a><span class="php-comment">   * time: The preference number of the show_season_requested_time that was selected, or -1
</span></span><span id="365" class="l"><a class="l" href="#365">365: </a><span class="php-comment">   * timecustom_day: Ignored if time is &gt; -1
</span></span><span id="366" class="l"><a class="l" href="#366">366: </a><span class="php-comment">   * If time = -1, this is the day # to schedule for
</span></span><span id="367" class="l"><a class="l" href="#367">367: </a><span class="php-comment">   * timecustom_stime: Ignored if time is &gt; -1
</span></span><span id="368" class="l"><a class="l" href="#368">368: </a><span class="php-comment">   * If time = -1, this is the start time to schedule for
</span></span><span id="369" class="l"><a class="l" href="#369">369: </a><span class="php-comment">   * timecustom_etime: Ignored if time is &gt;-1
</span></span><span id="370" class="l"><a class="l" href="#370">370: </a><span class="php-comment">   * If time = -1, this is the *duration* to schedule for (not end time)
</span></span><span id="371" class="l"><a class="l" href="#371">371: </a><span class="php-comment">   * 
</span></span><span id="372" class="l"><a class="l" href="#372">372: </a><span class="php-comment">   * @todo Validate timeslots are available before scheduling
</span></span><span id="373" class="l"><a class="l" href="#373">373: </a><span class="php-comment">   * @todo Email the user notifying them of scheduling
</span></span><span id="374" class="l"><a class="l" href="#374">374: </a><span class="php-comment">   * @todo Verify the timeslot is free before scheduling
</span></span><span id="375" class="l"><a class="l" href="#375">375: </a><span class="php-comment">   */</span>
</span><span id="376" class="l"><a class="l" href="#376">376: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_schedule" href="#_schedule">schedule</a>(<span class="php-var">$params</span>) {
</span><span id="377" class="l"><a class="l" href="#377">377: </a>    <span class="php-keyword2">date_default_timezone_set</span>(<span class="php-quote">'UTC'</span>);
</span><span id="378" class="l"><a class="l" href="#378">378: </a>    <span class="php-comment">//Verify that the input time is valid</span>
</span><span id="379" class="l"><a class="l" href="#379">379: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$params</span>[<span class="php-quote">'time'</span>]) <span class="php-keyword1">or</span> !<span class="php-keyword2">is_numeric</span>(<span class="php-var">$params</span>[<span class="php-quote">'time'</span>])) {
</span><span id="380" class="l"><a class="l" href="#380">380: </a>      <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'No valid Time was sent to the Scheduling Mapper.'</span>,
</span><span id="381" class="l"><a class="l" href="#381">381: </a>              MyURYException::FATAL);
</span><span id="382" class="l"><a class="l" href="#382">382: </a>    }
</span><span id="383" class="l"><a class="l" href="#383">383: </a>    <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'time'</span>] != -<span class="php-num">1</span> &amp;&amp; !<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;requested_times[<span class="php-var">$params</span>[<span class="php-quote">'time'</span>]])) {
</span><span id="384" class="l"><a class="l" href="#384">384: </a>      <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'The Time value sent is not a valid Requested Time Reference.'</span>,
</span><span id="385" class="l"><a class="l" href="#385">385: </a>              MyURYException::FATAL);
</span><span id="386" class="l"><a class="l" href="#386">386: </a>    }
</span><span id="387" class="l"><a class="l" href="#387">387: </a>    <span class="php-comment">//Verify the custom times are valid</span>
</span><span id="388" class="l"><a class="l" href="#388">388: </a>    <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'time'</span>] == -<span class="php-num">1</span> &amp;&amp; (
</span><span id="389" class="l"><a class="l" href="#389">389: </a>            !<span class="php-keyword1">isset</span>(<span class="php-var">$params</span>[<span class="php-quote">'timecustom_day'</span>]) <span class="php-keyword1">or</span> <span class="php-comment">//0 (monday) would fail an empty() test</span>
</span><span id="390" class="l"><a class="l" href="#390">390: </a>            !<span class="php-keyword1">isset</span>(<span class="php-var">$params</span>[<span class="php-quote">'timecustom_stime'</span>]) <span class="php-keyword1">or</span> <span class="php-comment">//Same again with midnight (00:00)</span>
</span><span id="391" class="l"><a class="l" href="#391">391: </a>            <span class="php-keyword1">empty</span>(<span class="php-var">$params</span>[<span class="php-quote">'timecustom_etime'</span>]))) {
</span><span id="392" class="l"><a class="l" href="#392">392: </a>      <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'The Custom Time value sent is invalid.'</span>,
</span><span id="393" class="l"><a class="l" href="#393">393: </a>              MyURYException::FATAL);
</span><span id="394" class="l"><a class="l" href="#394">394: </a>    }
</span><span id="395" class="l"><a class="l" href="#395">395: </a>    <span class="php-comment">//Okay, let's get to business</span>
</span><span id="396" class="l"><a class="l" href="#396">396: </a>    <span class="php-comment">//First, figure out what time things are happening</span>
</span><span id="397" class="l"><a class="l" href="#397">397: </a>    <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'time'</span>] != -<span class="php-num">1</span>) {
</span><span id="398" class="l"><a class="l" href="#398">398: </a>      <span class="php-comment">//Use the requested times value</span>
</span><span id="399" class="l"><a class="l" href="#399">399: </a>      <span class="php-var">$req_time</span> = <span class="php-var">$this</span>-&gt;requested_times[<span class="php-var">$params</span>[<span class="php-quote">'time'</span>]];
</span><span id="400" class="l"><a class="l" href="#400">400: </a>    } <span class="php-keyword1">else</span> {
</span><span id="401" class="l"><a class="l" href="#401">401: </a>      <span class="php-comment">//Use a custom value</span>
</span><span id="402" class="l"><a class="l" href="#402">402: </a>      <span class="php-comment">//If etime is before stime, it's probably spanning midnight so make it the 2nd</span>
</span><span id="403" class="l"><a class="l" href="#403">403: </a>      <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'timecustom_etime'</span>] &lt; <span class="php-var">$params</span>[<span class="php-quote">'timecustom_stime'</span>])
</span><span id="404" class="l"><a class="l" href="#404">404: </a>        <span class="php-var">$edate</span> = <span class="php-quote">'1970-01-02'</span>; <span class="php-keyword1">else</span>
</span><span id="405" class="l"><a class="l" href="#405">405: </a>        <span class="php-var">$edate</span> = <span class="php-quote">'1970-01-01'</span>;
</span><span id="406" class="l"><a class="l" href="#406">406: </a>      <span class="php-var">$dur</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$edate</span> . <span class="php-quote">' '</span> . <span class="php-var">$params</span>[<span class="php-quote">'timecustom_etime'</span>]) - <span class="php-keyword2">strtotime</span>(<span class="php-quote">'1970-01-01 '</span> . <span class="php-var">$params</span>[<span class="php-quote">'timecustom_stime'</span>]);
</span><span id="407" class="l"><a class="l" href="#407">407: </a>      <span class="php-keyword1">if</span> (<span class="php-var">$dur</span> &lt;= <span class="php-num">0</span>)
</span><span id="408" class="l"><a class="l" href="#408">408: </a>        <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MyURYException(<span class="php-quote">'A show has to last at least a second!'</span>, MyURYException::FATAL);
</span><span id="409" class="l"><a class="l" href="#409">409: </a>      <span class="php-var">$req_time</span> = <span class="php-keyword1">array</span>(
</span><span id="410" class="l"><a class="l" href="#410">410: </a>          <span class="php-quote">'day'</span> =&gt; <span class="php-var">$params</span>[<span class="php-quote">'timecustom_day'</span>],
</span><span id="411" class="l"><a class="l" href="#411">411: </a>          <span class="php-quote">'start_time'</span> =&gt; <span class="php-var">$params</span>[<span class="php-quote">'timecustom_stime'</span>],
</span><span id="412" class="l"><a class="l" href="#412">412: </a>          <span class="php-quote">'duration'</span> =&gt; <span class="php-var">$params</span>[<span class="php-quote">'timecustom_etime'</span>]
</span><span id="413" class="l"><a class="l" href="#413">413: </a>      );
</span><span id="414" class="l"><a class="l" href="#414">414: </a>    }
</span><span id="415" class="l"><a class="l" href="#415">415: </a>    <span class="php-comment">/**
</span></span><span id="416" class="l"><a class="l" href="#416">416: </a><span class="php-comment">     * Since terms start on the Monday, we just +1 day to it
</span></span><span id="417" class="l"><a class="l" href="#417">417: </a><span class="php-comment">     */</span>
</span><span id="418" class="l"><a class="l" href="#418">418: </a>    <span class="php-var">$start_day</span> = MyURY_Scheduler::getTermStartDate(
</span><span id="419" class="l"><a class="l" href="#419">419: </a>                    self::getActiveApplicationTerm()) + (<span class="php-var">$req_time</span>[<span class="php-quote">'day'</span>] * <span class="php-num">86400</span>);
</span><span id="420" class="l"><a class="l" href="#420">420: </a>
</span><span id="421" class="l"><a class="l" href="#421">421: </a>    <span class="php-var">$start_time</span> = <span class="php-keyword2">date</span>(<span class="php-quote">'H:i:s'</span>, <span class="php-var">$req_time</span>[<span class="php-quote">'start_time'</span>]);
</span><span id="422" class="l"><a class="l" href="#422">422: </a>
</span><span id="423" class="l"><a class="l" href="#423">423: </a>    <span class="php-comment">//Now it's time to BEGIN to COMMIT!</span>
</span><span id="424" class="l"><a class="l" href="#424">424: </a>    self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'BEGIN'</span>);
</span><span id="425" class="l"><a class="l" href="#425">425: </a>    <span class="php-comment">/**
</span></span><span id="426" class="l"><a class="l" href="#426">426: </a><span class="php-comment">     * This will iterate over each week, decide if it should be scheduled,
</span></span><span id="427" class="l"><a class="l" href="#427">427: </a><span class="php-comment">     * then schedule it if it should. Simples.
</span></span><span id="428" class="l"><a class="l" href="#428">428: </a><span class="php-comment">     */</span>
</span><span id="429" class="l"><a class="l" href="#429">429: </a>    <span class="php-var">$times</span> = <span class="php-quote">''</span>;
</span><span id="430" class="l"><a class="l" href="#430">430: </a>    <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt;= <span class="php-num">10</span>; <span class="php-var">$i</span>++) {
</span><span id="431" class="l"><a class="l" href="#431">431: </a>      <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$params</span>[<span class="php-quote">'weeks'</span>][<span class="php-quote">'wk'</span> . <span class="php-var">$i</span>]) &amp;&amp; <span class="php-var">$params</span>[<span class="php-quote">'weeks'</span>][<span class="php-quote">'wk'</span> . <span class="php-var">$i</span>] == <span class="php-num">1</span>) {
</span><span id="432" class="l"><a class="l" href="#432">432: </a>        <span class="php-var">$show_time</span> = <span class="php-keyword2">date</span>(<span class="php-quote">'d-m-Y '</span>, <span class="php-var">$start_day</span> + ((<span class="php-var">$i</span> - <span class="php-num">1</span>) * <span class="php-num">7</span> * <span class="php-num">86400</span>)) . <span class="php-var">$start_time</span>;
</span><span id="433" class="l"><a class="l" href="#433">433: </a>        <span class="php-keyword1">echo</span> <span class="php-var">$show_time</span> . <span class="php-quote">'&lt;br&gt;'</span>;
</span><span id="434" class="l"><a class="l" href="#434">434: </a>        <span class="php-comment">//This week is due to be scheduled! QUERY! QUERY!</span>
</span><span id="435" class="l"><a class="l" href="#435">435: </a>        self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'INSERT INTO schedule.show_season_timeslot
</span></span><span id="436" class="l"><a class="l" href="#436">436: </a><span class="php-quote">          (show_season_id, start_time, duration, memberid, approvedid)
</span></span><span id="437" class="l"><a class="l" href="#437">437: </a><span class="php-quote">          VALUES ($1, $2, $3, $4, $5)
</span></span><span id="438" class="l"><a class="l" href="#438">438: </a><span class="php-quote">          '</span>, <span class="php-keyword1">array</span>(
</span><span id="439" class="l"><a class="l" href="#439">439: </a>            <span class="php-var">$this</span>-&gt;season_id,
</span><span id="440" class="l"><a class="l" href="#440">440: </a>            <span class="php-var">$show_time</span>,
</span><span id="441" class="l"><a class="l" href="#441">441: </a>            <span class="php-var">$req_time</span>[<span class="php-quote">'duration'</span>],
</span><span id="442" class="l"><a class="l" href="#442">442: </a>            <span class="php-var">$this</span>-&gt;owner-&gt;getID(),
</span><span id="443" class="l"><a class="l" href="#443">443: </a>            <span class="php-var">$_SESSION</span>[<span class="php-quote">'memberid'</span>]
</span><span id="444" class="l"><a class="l" href="#444">444: </a>                ), <span class="php-keyword1">true</span>);
</span><span id="445" class="l"><a class="l" href="#445">445: </a>        <span class="php-var">$times</span> .= <span class="php-var">$show_time</span> . <span class="php-quote">&quot;\r\n&quot;</span>;
</span><span id="446" class="l"><a class="l" href="#446">446: </a>      }
</span><span id="447" class="l"><a class="l" href="#447">447: </a>    }
</span><span id="448" class="l"><a class="l" href="#448">448: </a>    <span class="php-comment">//COMMIT</span>
</span><span id="449" class="l"><a class="l" href="#449">449: </a>    self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'COMMIT'</span>);
</span><span id="450" class="l"><a class="l" href="#450">450: </a>    <span class="php-comment">//Email the user</span>
</span><span id="451" class="l"><a class="l" href="#451">451: </a>    <span class="php-var">$message</span> = <span class="php-quote">&lt;&lt;&lt;EOT
</span></span><span id="452" class="l"><a class="l" href="#452">452: </a><span class="php-quote">Hello,
</span></span><span id="453" class="l"><a class="l" href="#453">453: </a><span class="php-quote">  
</span></span><span id="454" class="l"><a class="l" href="#454">454: </a><span class="php-quote">  Please note that one of your shows has been allocated the following timeslots on the URY Schedule:
</span></span><span id="455" class="l"><a class="l" href="#455">455: </a><span class="php-quote">  
</span></span><span id="456" class="l"><a class="l" href="#456">456: </a><span class="php-var">$times</span><span class="php-quote">
</span></span><span id="457" class="l"><a class="l" href="#457">457: </a><span class="php-quote">    
</span></span><span id="458" class="l"><a class="l" href="#458">458: </a><span class="php-quote">  Remember that except in exceptional circumstances, you must give at least 48 hours notice for cancelling your show as part of your presenter contract. If you do not do this for two shows in one season, all other shows are forfeit and may be cancelled.
</span></span><span id="459" class="l"><a class="l" href="#459">459: </a><span class="php-quote">  
</span></span><span id="460" class="l"><a class="l" href="#460">460: </a><span class="php-quote">  If you have any questions about your application, direct them to pc@ury.org.uk
</span></span><span id="461" class="l"><a class="l" href="#461">461: </a><span class="php-quote">
</span></span><span id="462" class="l"><a class="l" href="#462">462: </a><span class="php-quote">  ~ URY Scheduling Wizard
</span></span><span id="463" class="l"><a class="l" href="#463">463: </a><span class="php-quote">EOT;
</span></span><span id="464" class="l"><a class="l" href="#464">464: </a>    <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$times</span>))
</span><span id="465" class="l"><a class="l" href="#465">465: </a>      MyURYEmail::sendEmail(<span class="php-var">$this</span>-&gt;owner-&gt;getEmail(), <span class="php-var">$this</span>-&gt;getMeta(<span class="php-quote">'title'</span>) . <span class="php-quote">' Scheduled'</span>, <span class="php-var">$message</span>);
</span><span id="466" class="l"><a class="l" href="#466">466: </a>
</span><span id="467" class="l"><a class="l" href="#467">467: </a>    <span class="php-comment">/**
</span></span><span id="468" class="l"><a class="l" href="#468">468: </a><span class="php-comment">     * Flush Memcached - there will be stale schedule entries for the website
</span></span><span id="469" class="l"><a class="l" href="#469">469: </a><span class="php-comment">     * This is for Django as the MyURY Cache system is currently APCProvider
</span></span><span id="470" class="l"><a class="l" href="#470">470: </a><span class="php-comment">     * @todo Consider setting up Memcached as an alternative CacheProvider implementation
</span></span><span id="471" class="l"><a class="l" href="#471">471: </a><span class="php-comment">     */</span>
</span><span id="472" class="l"><a class="l" href="#472">472: </a>    <span class="php-var">$m</span> = <span class="php-keyword1">new</span> Memcached();
</span><span id="473" class="l"><a class="l" href="#473">473: </a>    <span class="php-var">$m</span>-&gt;addServer(Config::<span class="php-var">$django_cache_server</span>, <span class="php-num">11211</span>);
</span><span id="474" class="l"><a class="l" href="#474">474: </a>    <span class="php-var">$m</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span id="475" class="l"><a class="l" href="#475">475: </a>
</span><span id="476" class="l"><a class="l" href="#476">476: </a>    <span class="php-keyword2">date_default_timezone_set</span>(<span class="php-quote">'Europe/London'</span>);
</span><span id="477" class="l"><a class="l" href="#477">477: </a>  }
</span><span id="478" class="l"><a class="l" href="#478">478: </a>
</span><span id="479" class="l"><a class="l" href="#479">479: </a>  <span class="php-comment">/**
</span></span><span id="480" class="l"><a class="l" href="#480">480: </a><span class="php-comment">   * Deletes all future occurances of a Timeslot for this Season
</span></span><span id="481" class="l"><a class="l" href="#481">481: </a><span class="php-comment">   */</span>
</span><span id="482" class="l"><a class="l" href="#482">482: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_cancelRestOfSeason" href="#_cancelRestOfSeason">cancelRestOfSeason</a>() {
</span><span id="483" class="l"><a class="l" href="#483">483: </a>    <span class="php-comment">//Get a list of timeslots that will be cancelled and email the creditors</span>
</span><span id="484" class="l"><a class="l" href="#484">484: </a>    <span class="php-var">$timeslots</span> = <span class="php-var">$this</span>-&gt;getFutureTimeslots();
</span><span id="485" class="l"><a class="l" href="#485">485: </a>    <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$timeslots</span>))
</span><span id="486" class="l"><a class="l" href="#486">486: </a>      <span class="php-keyword1">return</span>;
</span><span id="487" class="l"><a class="l" href="#487">487: </a>
</span><span id="488" class="l"><a class="l" href="#488">488: </a>    <span class="php-var">$timeslot_str</span> = <span class="php-quote">&quot;\r\n&quot;</span>;
</span><span id="489" class="l"><a class="l" href="#489">489: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$timeslots</span> <span class="php-keyword1">as</span> <span class="php-var">$timeslot</span>) {
</span><span id="490" class="l"><a class="l" href="#490">490: </a>      <span class="php-var">$timeslot_str</span> .= CoreUtils::happyTime(<span class="php-quote">&quot;</span><span class="php-var">{$timeslot['start_time']}</span><span class="php-quote">\r\n&quot;</span>);
</span><span id="491" class="l"><a class="l" href="#491">491: </a>    }
</span><span id="492" class="l"><a class="l" href="#492">492: </a>
</span><span id="493" class="l"><a class="l" href="#493">493: </a>    <span class="php-var">$email</span> = <span class="php-quote">'Please note that your show, '</span> . <span class="php-var">$this</span>-&gt;getMeta(<span class="php-quote">'title'</span>) . <span class="php-quote">' has been cancelled for the rest of the current Season. This is the following timeslots: '</span> . <span class="php-var">$timeslot_str</span>;
</span><span id="494" class="l"><a class="l" href="#494">494: </a>    <span class="php-var">$email</span> .= <span class="php-quote">&quot;\r\n\r\nRegards\r\nURY Programming Team&quot;</span>;
</span><span id="495" class="l"><a class="l" href="#495">495: </a>
</span><span id="496" class="l"><a class="l" href="#496">496: </a>    <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;getShow()-&gt;getCredits() <span class="php-keyword1">as</span> <span class="php-var">$credit</span>) {
</span><span id="497" class="l"><a class="l" href="#497">497: </a>      <span class="php-var">$u</span> = User::getInstance(<span class="php-var">$credit</span>);
</span><span id="498" class="l"><a class="l" href="#498">498: </a>      MyURYEmail::sendEmail(<span class="php-var">$u</span>-&gt;getName() . <span class="php-quote">' &lt;'</span> . <span class="php-var">$u</span>-&gt;getEmail() . <span class="php-quote">'&gt;'</span>, <span class="php-quote">'Show Cancelled'</span>, <span class="php-var">$email</span>);
</span><span id="499" class="l"><a class="l" href="#499">499: </a>    }
</span><span id="500" class="l"><a class="l" href="#500">500: </a>
</span><span id="501" class="l"><a class="l" href="#501">501: </a>    <span class="php-var">$r</span> = (bool) self::<span class="php-var">$db</span>-&gt;query(<span class="php-quote">'DELETE FROM schedule.show_season_timeslot WHERE show_season_id=$1 AND start_time &gt;= NOW()'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$this</span>-&gt;getID()));
</span><span id="502" class="l"><a class="l" href="#502">502: </a>
</span><span id="503" class="l"><a class="l" href="#503">503: </a>    <span class="php-var">$m</span> = <span class="php-keyword1">new</span> Memcached();
</span><span id="504" class="l"><a class="l" href="#504">504: </a>    <span class="php-var">$m</span>-&gt;addServer(Config::<span class="php-var">$django_cache_server</span>, <span class="php-num">11211</span>);
</span><span id="505" class="l"><a class="l" href="#505">505: </a>    <span class="php-var">$m</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span id="506" class="l"><a class="l" href="#506">506: </a>
</span><span id="507" class="l"><a class="l" href="#507">507: </a>    <span class="php-keyword1">return</span> <span class="php-var">$r</span>;
</span><span id="508" class="l"><a class="l" href="#508">508: </a>  }
</span><span id="509" class="l"><a class="l" href="#509">509: </a>
</span><span id="510" class="l"><a class="l" href="#510">510: </a>  <span class="php-comment">/**
</span></span><span id="511" class="l"><a class="l" href="#511">511: </a><span class="php-comment">   * Returns an array of Timeslots in the future for this Season as follows:
</span></span><span id="512" class="l"><a class="l" href="#512">512: </a><span class="php-comment">   * show_season_timeslot_id
</span></span><span id="513" class="l"><a class="l" href="#513">513: </a><span class="php-comment">   * start_time
</span></span><span id="514" class="l"><a class="l" href="#514">514: </a><span class="php-comment">   * duration
</span></span><span id="515" class="l"><a class="l" href="#515">515: </a><span class="php-comment">   * @todo Refactor to return MyURY_Timeslot objects
</span></span><span id="516" class="l"><a class="l" href="#516">516: </a><span class="php-comment">   */</span>
</span><span id="517" class="l"><a class="l" href="#517">517: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getFutureTimeslots" href="#_getFutureTimeslots">getFutureTimeslots</a>() {
</span><span id="518" class="l"><a class="l" href="#518">518: </a>    <span class="php-keyword1">return</span> self::<span class="php-var">$db</span>-&gt;fetch_all(<span class="php-quote">'SELECT show_season_timeslot_id, start_time, duration FROM schedule.show_season_timeslot
</span></span><span id="519" class="l"><a class="l" href="#519">519: </a><span class="php-quote">      WHERE show_season_id=$1 AND start_time &gt;= NOW()'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$this</span>-&gt;getID()));
</span><span id="520" class="l"><a class="l" href="#520">520: </a>  }
</span><span id="521" class="l"><a class="l" href="#521">521: </a>  
</span><span id="522" class="l"><a class="l" href="#522">522: </a>  <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getAllTimeslots" href="#_getAllTimeslots">getAllTimeslots</a>() {
</span><span id="523" class="l"><a class="l" href="#523">523: </a>    <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;timeslots;
</span><span id="524" class="l"><a class="l" href="#524">524: </a>  }
</span><span id="525" class="l"><a class="l" href="#525">525: </a>
</span><span id="526" class="l"><a class="l" href="#526">526: </a>}
</span><span id="527" class="l"><a class="l" href="#527">527: </a></span></code></pre>

	<div id="footer">
		MyURY API documentation generated by <a href="http://apigen.org">ApiGen 2.8.0</a>
	</div>
</div>
</div>
</body>
</html>
